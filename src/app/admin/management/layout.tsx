'use client'

import { useAuth } from '@/lib/auth-context'
import { ROLE_LABELS } from '@/lib/supabase'
import { useRouter, usePathname } from 'next/navigation'
import { useEffect } from 'react'
import { DashboardHeader } from '@/components/dashboard'
import Link from 'next/link'

interface ManagementLayoutProps {
  children: React.ReactNode
}

const sidebarItems = [
  {
    id: 'users',
    label: 'Người dùng',
    href: '/admin/management/users',
    icon: (active: boolean) => (
      <svg width="17" height="20" viewBox="0 0 17 21" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M15.0386 7.74353C15.0386 6.26695 14.4487 4.85093 13.399 3.80679C12.3492 2.76265 10.9253 2.17603 9.44072 2.17603C7.95614 2.17603 6.53226 2.76265 5.48248 3.80679C4.43271 4.85093 3.84277 6.26695 3.84277 7.74353V11.7895L3.84068 11.9177C3.81804 12.557 3.62639 13.18 3.28442 13.7236L2.22128 15.4151C2.19821 15.4519 2.18519 15.4942 2.18403 15.5376C2.18288 15.5809 2.19337 15.624 2.21458 15.6619C2.23578 15.6998 2.26681 15.7313 2.30437 15.7533C2.34193 15.7753 2.38482 15.787 2.42838 15.787H16.4528C16.4964 15.787 16.5393 15.7753 16.5768 15.7533C16.6144 15.7313 16.6455 15.6998 16.6666 15.6619C16.6877 15.624 16.6983 15.5809 16.6971 15.5376C16.696 15.4942 16.683 15.4519 16.6602 15.4151L15.5968 13.7238C15.2323 13.1446 15.039 12.4752 15.0386 11.7919V7.74353ZM16.5048 11.7912L16.506 11.8678C16.5197 12.2511 16.6346 12.6245 16.8396 12.9503L17.9034 14.6423L17.9328 14.691C18.076 14.9368 18.1553 15.2147 18.1628 15.4994C18.1709 15.8029 18.097 16.1031 17.949 16.3687C17.801 16.6343 17.5842 16.8557 17.3212 17.0098C17.0581 17.1639 16.7581 17.2453 16.4528 17.2452H2.42838C2.12308 17.2452 1.82327 17.1639 1.56028 17.0098C1.29723 16.8557 1.08043 16.6343 0.932416 16.3687C0.784406 16.1031 0.710311 15.8029 0.71834 15.4994C0.726425 15.1958 0.816159 14.8999 0.977951 14.6423L2.04129 12.9506C2.26026 12.6026 2.37671 12.2002 2.37657 11.7897V7.74353C2.37657 5.88015 3.12077 4.0931 4.44554 2.7755C5.77037 1.4579 7.56723 0.717773 9.44072 0.717773C11.3142 0.717773 13.1108 1.458 14.4356 2.7755C15.7604 4.0931 16.5048 5.88015 16.5048 7.74353V11.7912Z"
          fill={active ? 'white' : '#FA865E'}
        />
        <path
          d="M11.1104 18.1636C11.4562 18.1636 11.7365 18.5747 11.7365 19.0818C11.7365 19.5889 11.4562 20 11.1104 20H7.77153C7.42578 20 7.14551 19.5889 7.14551 19.0818C7.14551 18.5747 7.42578 18.1636 7.77153 18.1636H11.1104Z"
          fill={active ? 'white' : '#FA865E'}
        />
      </svg>
    ),
  },
  {
    id: 'classes',
    label: 'Lớp học',
    href: '/admin/management/classes',
    icon: (active: boolean) => (
      <svg width="18" height="21" viewBox="0 0 18 22" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M13.5218 8.39742V5.14678C13.5218 4.21294 13.1508 3.31709 12.4904 2.65669C11.8507 2.01703 10.9901 1.64881 10.0879 1.62636L10.0003 1.62534C9.06644 1.62534 8.17068 1.99628 7.51028 2.65669C6.84982 3.31709 6.47881 4.21294 6.47881 5.14678V8.39742C6.47881 8.84628 6.11505 9.21012 5.66619 9.21012C5.21733 9.21012 4.8535 8.84628 4.8535 8.39742V5.14678C4.8535 3.78176 5.39594 2.47279 6.36111 1.50763C7.32627 0.542395 8.63533 0 10.0003 0L10.1281 0.00159752C11.4468 0.034295 12.7045 0.572455 13.6396 1.50763C14.6048 2.47279 15.1471 3.78176 15.1471 5.14678V8.39742C15.1471 8.84628 14.7833 9.21012 14.3345 9.21012C13.8857 9.21012 13.5218 8.84628 13.5218 8.39742Z"
          fill={active ? 'white' : '#FA865E'}
        />
        <path
          d="M16.7726 9.21027H3.22833V18.1494L3.22993 18.2171C3.24654 18.5512 3.38702 18.8686 3.62514 19.1067C3.8791 19.3607 4.22348 19.5035 4.58275 19.5035H15.4182C15.7774 19.5035 16.1218 19.3607 16.3758 19.1067C16.6298 18.8527 16.7726 18.5084 16.7726 18.1494V9.21027ZM18.3979 18.1494C18.3979 18.9397 18.084 19.6977 17.5252 20.2565C16.9664 20.8153 16.2084 21.1291 15.4182 21.1291H4.58275C3.79249 21.1291 3.03449 20.8153 2.47567 20.2565C1.91693 19.6977 1.60303 18.9397 1.60303 18.1494V8.39763C1.60303 7.94877 1.96686 7.58501 2.41572 7.58501H17.5852C18.0341 7.58501 18.3979 7.94877 18.3979 8.39763V18.1494Z"
          fill={active ? 'white' : '#FA865E'}
        />
        <path
          d="M12.7196 13.1377C13.3928 13.1377 13.9386 13.6835 13.9386 14.3567V14.3676C13.9386 15.0408 13.3928 15.5866 12.7196 15.5866H12.7087C12.0355 15.5866 11.4898 15.0408 11.4897 14.3676V14.3567C11.4897 13.6835 12.0355 13.1377 12.7087 13.1377H12.7196Z"
          fill={active ? 'white' : '#FA865E'}
        />
      </svg>
    ),
  },
  {
    id: 'students',
    label: 'Thiếu nhi',
    href: '/admin/management/students',
    icon: (active: boolean) => (
      <svg width="20" height="20" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M4.58124 4.60303C6.06182 3.11703 8.01182 2.19103 10.0987 1.98303C12.1856 1.77403 14.2802 2.29603 16.0255 3.45903C17.7708 4.62203 19.0587 6.35403 19.6695 8.36003C20.2804 10.367 20.1765 12.523 19.3755 14.461C18.5745 16.4 17.126 18 15.277 18.99C13.4279 19.98 11.2928 20.298 9.23564 19.889C7.17846 19.481 5.32664 18.372 3.99578 16.751C2.66493 15.13 1.9375 13.097 1.9375 11C1.9375 10.751 1.83875 10.513 1.66293 10.337C1.48711 10.161 1.24864 10.063 1 10.063C0.75136 10.063 0.512891 10.161 0.337071 10.337C0.161251 10.513 0.0625 10.751 0.0625 11C0.0624 13.531 0.940294 15.984 2.54653 17.941C4.15276 19.897 6.38768 21.236 8.87057 21.729C11.3535 22.222 13.9303 21.838 16.162 20.643C18.3936 19.449 20.1418 17.517 21.1085 15.177C22.0752 12.838 22.2005 10.236 21.4631 7.81403C20.7257 5.39303 19.1712 3.30203 17.0647 1.89803C14.9582 0.495032 12.43 -0.134968 9.91134 0.117032C7.39263 0.369032 5.03932 1.48703 3.25249 3.28003C3.22161 3.31203 3.19243 3.34503 3.16503 3.38003L1.59375 1.80803C1.50968 1.72303 1.40339 1.66503 1.28729 1.63903C1.17118 1.61303 1.05012 1.62103 0.938248 1.66103C0.826372 1.70203 0.728439 1.77403 0.655946 1.86803C0.583452 1.96203 0.539257 2.07503 0.528666 2.19403L0.0875001 7.05503C0.0793337 7.14603 0.0910992 7.23803 0.122286 7.32403C0.153473 7.41003 0.203335 7.48903 0.268012 7.55303C0.332757 7.61803 0.411034 7.66803 0.497113 7.69903C0.583193 7.73003 0.674993 7.74203 0.766251 7.73403L5.62875 7.29103C5.74685 7.28003 5.85918 7.23603 5.95297 7.16303C6.04675 7.09003 6.11779 6.99303 6.15804 6.88103C6.19828 6.77003 6.20601 6.64903 6.18024 6.53303C6.15447 6.41803 6.09627 6.31103 6.01249 6.22803L4.47751 4.69303C4.51374 4.66403 4.54829 4.63403 4.58124 4.60303Z"
          fill={active ? 'white' : '#FA865E'}
        />
        <path
          d="M11.9375 4.75C11.9375 4.501 11.8387 4.263 11.6629 4.087C11.4871 3.911 11.2486 3.812 11 3.812C10.7514 3.812 10.5129 3.911 10.3371 4.087C10.1613 4.263 10.0625 4.501 10.0625 4.75V11C10.0624 11.159 10.1028 11.315 10.1797 11.454C10.2567 11.593 10.3678 11.711 10.5025 11.795L14.2525 14.139C14.4633 14.271 14.718 14.313 14.9604 14.258C15.0804 14.23 15.1938 14.179 15.2941 14.108C15.3944 14.036 15.4797 13.946 15.545 13.841C15.6103 13.737 15.6545 13.621 15.6749 13.499C15.6953 13.378 15.6916 13.253 15.6639 13.133C15.6363 13.013 15.5853 12.9 15.5139 12.8C15.4424 12.699 15.3519 12.614 15.2475 12.549L11.9375 10.48V4.75Z"
          fill={active ? 'white' : '#FA865E'}
        />
      </svg>
    ),
  },
]

export default function ManagementLayout({ children }: ManagementLayoutProps) {
  const { user, loading, isAdmin } = useAuth()
  const router = useRouter()
  const pathname = usePathname()

  useEffect(() => {
    if (!loading && !user) {
      router.push('/login')
    }
    if (!loading && user && !isAdmin) {
      router.push('/dashboard')
    }
  }, [user, loading, isAdmin, router])

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="flex flex-col items-center gap-4">
          <svg className="animate-spin h-8 w-8 text-brand" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <p className="text-gray-500 text-sm">Dang tai...</p>
        </div>
      </div>
    )
  }

  if (!user || !isAdmin) {
    return null
  }

  const firstName = user.full_name?.split(' ').pop() || user.full_name

  // Determine active sidebar item
  const getActiveItem = () => {
    if (pathname?.includes('/users')) return 'users'
    if (pathname?.includes('/classes')) return 'classes'
    if (pathname?.includes('/students')) return 'students'
    return 'users'
  }

  const activeItem = getActiveItem()

  return (
    <div className="min-h-screen flex flex-col">
      {/* Header */}
      <DashboardHeader
        userName={firstName || 'Admin'}
        userRole={ROLE_LABELS[user.role]}
        activeTab="management"
        userAvatar={user.avatar_url}
      />

      {/* Main Content Area */}
      <div className="flex-1 flex px-5 pb-5 gap-5">
        {/* Left Sidebar */}
        <aside className="w-[208px] flex-shrink-0">
          <nav className="flex flex-col gap-2.5">
            {sidebarItems.map((item) => {
              const isActive = activeItem === item.id
              return (
                <Link
                  key={item.id}
                  href={item.href}
                  className={`flex items-center gap-3 pl-2 pr-4 h-14 rounded-full transition-all shadow-sm ${
                    isActive
                      ? 'bg-brand text-white'
                      : 'bg-[#F6F6F6] text-black hover:bg-gray-100'
                  }`}
                >
                  {/* Icon Circle */}
                  <div
                    className={`w-11 h-11 rounded-full flex items-center justify-center flex-shrink-0 ${
                      isActive ? 'bg-white/20' : 'bg-brand/20'
                    }`}
                  >
                    {item.icon(isActive)}
                  </div>
                  <span className={`text-sm ${isActive ? 'font-medium' : 'font-normal'}`}>
                    {item.label}
                  </span>
                </Link>
              )
            })}
          </nav>
        </aside>

        {/* Main Content */}
        <main className="flex-1">
          {children}
        </main>
      </div>
    </div>
  )
}
